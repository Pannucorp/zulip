# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build-zulip:
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    machine:
      image: ubuntu-2004:202010-01
    resource_class: medium
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run:
          name: "Set up the repository - 1"
          command: "sudo apt-get update && sudo apt-get install ca-certificates curl gnupg lsb-release"
      - run:
          name: "Set up the repository - 2"
          command: "curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg"
      - run:
          name: "Set up the repository - 3"
          command: echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      - run:
          name: "Install docker engine"
          command: "sudo apt-get update && sudo apt-get install docker-ce docker-ce-cli containerd.io"
      - run:
          name: "Add user to the group"
          command: "sudo adduser $USER docker"
      - run:
          name: "Install exact bundler"
          command: "gem install bundler -v \"$(grep -A 1 \"BUNDLED WITH\" Gemfile.lock | tail -n 1)\""
      - run:
          name: "Deploy zulip"
          command: "vagrant up --provider=docker"
      - run:
          name: "Install exact bundler"
          command: "gem install bundler -v \"$(grep -A 1 \"BUNDLED WITH\" Gemfile.lock | tail -n 1)\""
      - run:
          name: "Deploy zulip"
          command: "vagrant up --provider=docker"

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  zulip-workflow:
    jobs:
      - build-zulip
